generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Complaint {
  id              String          @id @default(cuid())
  complaintId     String?         @unique // Human-readable complaint ID like KSC0001
  title           String?
  description     String
  // Legacy string type retained for backward compatibility
  type            String?
  complaintTypeId Int?
  status          ComplaintStatus @default(REGISTERED)
  priority        Priority        @default(MEDIUM)
  slaStatus       SLAStatus       @default(ON_TIME)

  // Location Information
  wardId      String?
  subZoneId   String?
  area        String?
  landmark    String?
  address     String?
  coordinates String? // JSON string for lat/lng
  latitude    Float? // Explicit latitude field
  longitude   Float? // Explicit longitude field

  // Contact Information
  contactName  String?
  contactEmail String?
  contactPhone String
  isAnonymous  Boolean @default(false)

  // Assignment and Tracking
  submittedById     String?
  assignedToId      String? // Generic assignment field (kept for backward compatibility)
  resolvedById      String?
  wardOfficerId     String? // Automatically assigned ward officer
  maintenanceTeamId String? // Assigned maintenance team member

  // Timestamps
  submittedOn DateTime  @default(now())
  assignedOn  DateTime?
  resolvedOn  DateTime?
  closedOn    DateTime?
  deadline    DateTime?

  // Additional Information
  remarks         String?
  citizenFeedback String?
  rating          Int? // 1-5 rating
  assignToTeam    Boolean @default(false) // Team assignment flag
  tags            String? // JSON array of tags
  slmsRef         Int?
  faultSync       FaultSync? @relation(fields: [slmsRef], references: [id])

  // Relations - Only active models
  statusLogs      StatusLog[]
  complaintType   ComplaintType? @relation(fields: [complaintTypeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("complaints")
}

model StatusLog {
  id          String    @id @default(cuid())
  complaintId String
  userId      String    @map("userId")
  fromStatus  String?
  toStatus    String
  comment     String?
  timestamp   DateTime  @default(now()) @map("timestamp")
  createdAt   DateTime  @default(now())
  complaint   Complaint @relation(fields: [complaintId], references: [id])

  @@map("status_logs")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  fullName  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model FaultSync {
  id         Int      @id @default(autoincrement())
  rtuNumber  BigInt
  poleNo     String?
  sourceType String
  tagNo      String
  tagValue   String
  eventTime  DateTime @map("event_time")
  createdAt  DateTime @default(now())

  complaints Complaint[]

  @@map("fault_sync")
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  type        String?
  description String?
  isActive    Boolean  @default(true)
  updatedAt   DateTime @updatedAt

  @@index([key, isActive])
  @@index([type])
  @@map("system_config")
}

model ComplaintType {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  description String?
  priority    Priority    @default(MEDIUM)
  slaHours    Int         @default(48)
  isActive    Boolean     @default(true)
  complaints  Complaint[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([isActive])
  @@map("complaint_types")
}

enum ComplaintStatus {
  REGISTERED
  ASSIGNED
  IN_PROGRESS
  RESOLVED
  CLOSED
  REOPENED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SLAStatus {
  ON_TIME
  WARNING
  OVERDUE
  COMPLETED
}
